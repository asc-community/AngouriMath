name: 'Upload to MyGet and NuGet'

on:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  myget:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'
          dotnet-quality: 'preview'
          
      - uses: actions/checkout@v6
        
      - name: 'Pack AngouriMath for MyGet'
        run: |
          cd Sources
 
          # versioning
          commithash=$(git rev-parse --short HEAD)
          currtime=$(date +%s)
          echo "commit hash is $commithash"
          echo "time is $currtime"
          name=10.0.0-master-$currtime-$commithash
          echo "name is $name"
          
          # AngouriMath
          cd AngouriMath
          dotnet restore AngouriMath.csproj
          dotnet build AngouriMath.csproj -c release
          dotnet pack AngouriMath.csproj -c release -p:PackageVersion=$name
          cd bin/release
          dotnet nuget push AngouriMath.$name.nupkg --api-key ${{ secrets.MYGET_KEY }} --source "myget"
          cd ../../..
          
          # AngouriMath.FSharp
          cd Wrappers/AngouriMath.FSharp
          dotnet restore
          dotnet build -c Release
          dotnet pack -c Release -p:PackageVersion=$name
          cd bin/Release
          dotnet nuget push AngouriMath.FSharp.$name.nupkg --api-key ${{ secrets.MYGET_KEY }} --source "myget"
          cd ../../../..
          
          # AngouriMath.Interactive
          cd Wrappers/AngouriMath.Interactive
          dotnet restore
          dotnet build -c Release
          dotnet pack -c Release -p:PackageVersion=$name
          cd bin/Release
          dotnet nuget push AngouriMath.Interactive.$name.nupkg --api-key ${{ secrets.MYGET_KEY }} --source "myget"
          cd ../../../..

  nuget:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'
          dotnet-quality: 'preview'
          
      - uses: actions/checkout@v6
        
      - name: 'Pack AngouriMath for NuGet'
        run: |
          cd Sources
 
          # Get version from release tag
          tagname="${{ github.event.release.tag_name }}"
          
          # Validate tag name exists
          if [[ -z "$tagname" ]]; then
            echo "Error: Release tag name is empty"
            exit 1
          fi
          
          # Remove 'v' prefix if present (e.g., v1.0.0 -> 1.0.0)
          version="${tagname#v}"
          echo "Release tag is $tagname"
          echo "Package version is $version"
          
          # Validate version format (SemVer 2.0.0: X.Y.Z[-prerelease][+build])
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "Error: Invalid version format '$version'."
            echo "Expected semantic version (e.g., 1.0.0, 1.0.0-beta.1, 1.0.0+build.123)"
            exit 1
          fi
          
          # AngouriMath
          cd AngouriMath
          dotnet restore AngouriMath.csproj
          dotnet build AngouriMath.csproj -c release
          dotnet pack AngouriMath.csproj -c release -p:PackageVersion=$version
          cd bin/release
          dotnet nuget push AngouriMath.$version.nupkg --api-key ${{ secrets.NUGET_KEY }} --source "nuget.org"
          cd ../../..
          
          # AngouriMath.FSharp
          cd Wrappers/AngouriMath.FSharp
          dotnet restore
          dotnet build -c Release
          dotnet pack -c Release -p:PackageVersion=$version
          cd bin/Release
          dotnet nuget push AngouriMath.FSharp.$version.nupkg --api-key ${{ secrets.NUGET_KEY }} --source "nuget.org"
          cd ../../../..
          
          # AngouriMath.Interactive
          cd Wrappers/AngouriMath.Interactive
          dotnet restore
          dotnet build -c Release
          dotnet pack -c Release -p:PackageVersion=$version
          cd bin/Release
          dotnet nuget push AngouriMath.Interactive.$version.nupkg --api-key ${{ secrets.NUGET_KEY }} --source "nuget.org"
          cd ../../../..
