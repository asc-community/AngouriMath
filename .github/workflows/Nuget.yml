name: 'Publish to NuGet on Release'

on:
  release:
    types: [published]

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.x'
          dotnet-quality: 'preview'
          
      - uses: actions/checkout@v6
        
      - name: 'Pack AngouriMath'
        run: |
          cd Sources
 
          # Get version from release tag
          tagname="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present (e.g., v1.0.0 -> 1.0.0)
          version="${tagname#v}"
          echo "Release tag is $tagname"
          echo "Package version is $version"
          
          # Validate version format (basic check for semantic versioning)
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "Error: Invalid version format '$version'. Expected semantic version (e.g., 1.0.0, 1.0.0-beta.1)"
            exit 1
          fi
          
          # AngouriMath
          cd AngouriMath
          dotnet restore AngouriMath.csproj
          dotnet build AngouriMath.csproj -c release
          dotnet pack AngouriMath.csproj -c release -p:PackageVersion=$version
          cd bin/release
          dotnet nuget push AngouriMath.$version.nupkg --api-key ${{ secrets.NUGET_KEY }} --source "nuget.org"
          cd ../../..
          
          # AngouriMath.FSharp
          cd Wrappers/AngouriMath.FSharp
          dotnet restore
          dotnet build -c Release
          dotnet pack -c Release -p:PackageVersion=$version
          cd bin/Release
          dotnet nuget push AngouriMath.FSharp.$version.nupkg --api-key ${{ secrets.NUGET_KEY }} --source "nuget.org"
          cd ../../../..
          
          # AngouriMath.Interactive
          cd Wrappers/AngouriMath.Interactive
          dotnet restore
          dotnet build -c Release
          dotnet pack -c Release -p:PackageVersion=$version
          cd bin/Release
          dotnet nuget push AngouriMath.Interactive.$version.nupkg --api-key ${{ secrets.NUGET_KEY }} --source "nuget.org"
          cd ../../../..
